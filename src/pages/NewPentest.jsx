import React, { useState, useEffect } from 'react';
import { createJob } from '../api/client';
import { useNavigate } from 'react-router-dom';
import { useAuthStore } from '../stores/authStore';
import { getTargets, createTarget, deleteTarget } from '../api/targets';
import { getQueueItems, createQueueItem, updateQueueItem } from '../api/queue';

export default function NewPentest() {
  const [targets, setTargetsState] = useState([]);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newTarget, setNewTarget] = useState({
    name: '',
    url: '',
    description: ''
  });
  const [deleteConfirm, setDeleteConfirm] = useState(null); // { id, name }
  const [scheduleModal, setScheduleModal] = useState(null); // { target }
  const [scheduleDate, setScheduleDate] = useState('');
  const [scheduleTime, setScheduleTime] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [successModal, setSuccessModal] = useState(null); // { message, redirect }
  const navigate = useNavigate();

  const { user } = useAuthStore();

  // Load targets from API on mount
  useEffect(() => {
    fetchTargets();
  }, []);

  const fetchTargets = async () => {
    try {
      const data = await getTargets();
      setTargetsState(data);
    } catch (error) {
      console.error('Failed to fetch targets:', error);
    }
  };

  const handleAddTarget = async (e) => {
    e.preventDefault();
    try {
      await createTarget({
        name: newTarget.name,
        url: newTarget.url,
        description: newTarget.description || ''
      });
      setNewTarget({ name: '', url: '', description: '' });
      setShowAddForm(false);
      fetchTargets(); // Refresh list
    } catch (error) {
      console.error('Failed to create target:', error);
    }
  };

  const handleDeleteTarget = (targetId) => {
    const target = targets.find(t => t.id === targetId);
    setDeleteConfirm({ id: targetId, name: target.name });
  };

  const confirmDelete = async () => {
    try {
      await deleteTarget(deleteConfirm.id);
      setDeleteConfirm(null);
      fetchTargets(); // Refresh list
    } catch (error) {
      console.error('Failed to delete target:', error);
    }
  };

  const cancelDelete = () => {
    setDeleteConfirm(null);
  };

  // Check scheduled pentests every minute (sequential execution)
  useEffect(() => {
    checkScheduledPentests();
    const interval = setInterval(checkScheduledPentests, 60000); // Check every minute
    return () => clearInterval(interval);
  }, []);

  const checkScheduledPentests = async () => {
    try {
      const queue = await getQueueItems();
      const now = new Date().getTime();

      // Check if there's already a running pentest
      const runningPentest = localStorage.getItem('running_pentest');
      if (runningPentest) {
        return;
      }

      // Find the first pending pentest that's due
      const scheduled = queue.find(s => {
        const scheduledTime = new Date(s.scheduled_for).getTime();
        return scheduledTime <= now && s.status === 'pending';
      });

      if (scheduled) {
        try {
          // Mark as running
          localStorage.setItem('running_pentest', scheduled.id);

          const job = await createJob({
            target: scheduled.target_data.url,
            client: scheduled.target_data.name,
            description: scheduled.target_data.description,
            scan_type: "full"
          });

          // Mark as completed
          await updateQueueItem(scheduled.id, {
            status: 'completed',
            job_id: job.id
          });
          localStorage.removeItem('running_pentest');
        } catch (error) {
          console.error('Failed to execute scheduled pentest:', error);
          await updateQueueItem(scheduled.id, {
            status: 'failed'
          });
          localStorage.removeItem('running_pentest');
        }
      }
    } catch (error) {
      console.error('Failed to check scheduled pentests:', error);
    }
  };

  const handleSchedulePentest = (target) => {
    setScheduleModal({ target });
  };

  const executeImmediately = async () => {
    const target = scheduleModal.target;
    setScheduleModal(null);

    try {
      const queue = await getQueueItems();

      // Check if there's already an immediate pentest (priority 0)
      const hasImmediatePentest = queue.some(s => s.priority === 0 && s.status === 'pending');
      const priority = hasImmediatePentest ? 1 : 0;

      // Schedule for 1 minute from now
      const scheduledFor = new Date();
      scheduledFor.setMinutes(scheduledFor.getMinutes() + 1);

      await createQueueItem({
        target_id: target.id,
        target_data: target,
        scheduled_for: scheduledFor.toISOString(),
        priority: priority
      });

      setSuccessModal({
        title: 'Pentest Queued',
        message: `Pentest queued as #${priority + 1} (starting in ~1 minute)`,
        redirect: '/queue'
      });
    } catch (error) {
      console.error('Failed to queue pentest:', error);
      setSuccessModal({
        title: 'Error',
        message: 'Failed to queue pentest',
        isError: true
      });
    }
  };

  const scheduleForLater = async () => {
    if (!scheduleDate || !scheduleTime) {
      setSuccessModal({
        title: 'Missing Information',
        message: 'Please select both date and time',
        isError: true
      });
      return;
    }

    const scheduledFor = new Date(`${scheduleDate}T${scheduleTime}`);
    const now = new Date();

    if (scheduledFor <= now) {
      setSuccessModal({
        title: 'Invalid Date',
        message: 'Please select a future date and time',
        isError: true
      });
      return;
    }

    try {
      await createQueueItem({
        target_id: scheduleModal.target.id,
        target_data: scheduleModal.target,
        scheduled_for: scheduledFor.toISOString(),
        priority: 999
      });

      setScheduleModal(null);
      setScheduleDate('');
      setScheduleTime('');
      setSuccessModal({
        title: 'Pentest Scheduled',
        message: `Pentest scheduled for ${scheduledFor.toLocaleString()}`,
        redirect: '/queue'
      });
    } catch (error) {
      console.error('Failed to schedule pentest:', error);
      setSuccessModal({
        title: 'Error',
        message: 'Failed to schedule pentest',
        isError: true
      });
    }
  };

  const cancelSchedule = () => {
    setScheduleModal(null);
    setScheduleDate('');
    setScheduleTime('');
  };

  return (
    <div className="min-h-screen bg-[#02030a] p-8 pt-12">
      {/* Delete Confirmation Modal */}
      {deleteConfirm && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={cancelDelete}>
          <div className="bg-[#0a0b14] border border-white/20 rounded-xl p-8 max-w-md mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center">
                <span className="text-3xl">⚠️</span>
              </div>
              <h2 className="text-2xl font-bold text-white mb-2">Delete Target?</h2>
              <p className="text-white/60">
                Are you sure you want to delete <span className="text-white font-semibold">"{deleteConfirm.name}"</span>?
              </p>
              <p className="text-white/40 text-sm mt-2">This action cannot be undone.</p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={cancelDelete}
                className="flex-1 bg-white/5 hover:bg-white/10 text-white font-medium py-3 px-4 rounded-lg border border-white/10 hover:border-white/20 transition-all duration-200"
              >
                Cancel
              </button>
              <button
                onClick={confirmDelete}
                className="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-[0_0_20px_rgba(239,68,68,0.3)] hover:shadow-[0_0_30px_rgba(239,68,68,0.5)] transition-all duration-200"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Schedule Pentest Modal */}
      {scheduleModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={cancelSchedule}>
          <div className="bg-[#0a0b14] border border-white/20 rounded-xl p-8 max-w-lg mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="mb-6">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-[#FFA317]/10 flex items-center justify-center">
                <svg className="w-8 h-8 text-[#FFA317]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  <line x1="16" y1="2" x2="16" y2="6" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="8" y1="2" x2="8" y2="6" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="3" y1="10" x2="21" y2="10" strokeWidth="2" strokeLinecap="round"/>
                </svg>
              </div>
              <h2 className="text-2xl font-bold text-white mb-2 text-center">Schedule Pentest</h2>
              <p className="text-white/60 text-center">
                Target: <span className="text-white font-semibold">"{scheduleModal.target.name}"</span>
              </p>
            </div>

            <div className="space-y-6 mb-6">
              {/* Run Immediately Button */}
              <button
                onClick={executeImmediately}
                className="w-full bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317] text-white font-bold py-4 px-6 rounded-lg shadow-[0_0_20px_rgba(255,163,23,0.3)] hover:shadow-[0_0_30px_rgba(255,163,23,0.5)] transition-all duration-200"
              >
                ▶ Run Immediately
              </button>

              {/* Divider */}
              <div className="relative">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-white/10"></div>
                </div>
                <div className="relative flex justify-center text-xs">
                  <span className="px-3 bg-[#0a0b14] text-white/40">OR SCHEDULE FOR LATER</span>
                </div>
              </div>

              {/* Date and Time Inputs */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-white/70 text-sm font-medium mb-2">Date</label>
                  <input
                    type="date"
                    value={scheduleDate}
                    onChange={(e) => setScheduleDate(e.target.value)}
                    min={new Date().toISOString().split('T')[0]}
                    className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
                  />
                </div>
                <div>
                  <label className="block text-white/70 text-sm font-medium mb-2">Time</label>
                  <input
                    type="time"
                    value={scheduleTime}
                    onChange={(e) => setScheduleTime(e.target.value)}
                    className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
                  />
                </div>
              </div>

              <button
                onClick={scheduleForLater}
                disabled={!scheduleDate || !scheduleTime}
                className={`w-full bg-white/5 hover:bg-white/10 text-white font-medium py-3 px-4 rounded-lg border border-white/10 hover:border-[#FFA317] transition-all duration-200 flex items-center justify-center gap-2 ${(!scheduleDate || !scheduleTime) ? 'opacity-50 cursor-not-allowed' : ''}`}
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  <line x1="16" y1="2" x2="16" y2="6" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="8" y1="2" x2="8" y2="6" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="3" y1="10" x2="21" y2="10" strokeWidth="2" strokeLinecap="round"/>
                </svg>
                <span>Schedule for {scheduleDate && scheduleTime ? new Date(`${scheduleDate}T${scheduleTime}`).toLocaleString() : 'Selected Time'}</span>
              </button>
            </div>

            {/* Cancel Button */}
            <button
              onClick={cancelSchedule}
              className="w-full bg-transparent hover:bg-white/5 text-white/60 hover:text-white font-medium py-2 px-4 rounded-lg transition-all duration-200"
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Success/Error Modal */}
      {successModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" onClick={() => {
          setSuccessModal(null);
          if (successModal.redirect) navigate(successModal.redirect);
        }}>
          <div className="bg-[#0a0b14] border border-white/20 rounded-xl p-8 max-w-md mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className={`w-16 h-16 mx-auto mb-4 rounded-full ${successModal.isError ? 'bg-red-500/10' : 'bg-[#FFA317]/10'} flex items-center justify-center`}>
                {successModal.isError ? (
                  <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                ) : (
                  <svg className="w-8 h-8 text-[#FFA317]" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                )}
              </div>
              <h2 className="text-2xl font-bold text-white mb-2">{successModal.title}</h2>
              <p className="text-white/60">{successModal.message}</p>
            </div>
            <button
              onClick={() => {
                setSuccessModal(null);
                if (successModal.redirect) navigate(successModal.redirect);
              }}
              className={`w-full ${successModal.isError ? 'bg-red-500 hover:bg-red-600' : 'bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317]'} text-white font-bold py-3 px-4 rounded-lg shadow-[0_0_20px_rgba(255,163,23,0.3)] hover:shadow-[0_0_30px_rgba(255,163,23,0.5)] transition-all duration-200`}
            >
              {successModal.redirect ? 'Continue' : 'OK'}
            </button>
          </div>
        </div>
      )}

      <div className="max-w-6xl mx-auto">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-3xl font-bold text-white tracking-wide mb-2" style={{ fontFamily: 'Montserrat, sans-serif' }}>
              MANAGE TARGETS
            </h1>
            <div className="h-0.5 w-32 bg-gradient-to-r from-[#FFA317] to-transparent"></div>
          </div>
          <button
            onClick={() => setShowAddForm(!showAddForm)}
            className="bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317] text-white font-bold py-3 px-6 rounded-lg shadow-[0_0_20px_rgba(255,163,23,0.3)] hover:shadow-[0_0_30px_rgba(255,163,23,0.5)] transition-all duration-200"
          >
            {showAddForm ? '✕ Cancel' : '+ Add New Target'}
          </button>
        </div>

        {/* Search Field */}
        <div className="mb-6">
          <input
            type="text"
            placeholder="Search targets by name, URL, or description..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full bg-[#0a0b14] border border-white/10 rounded-lg py-3 px-4 text-white placeholder-white/40 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
          />
        </div>

        {/* Add Target Form */}
        {showAddForm && (
          <div className="bg-[#0a0b14] border border-white/10 rounded-xl p-8 mb-8 shadow-lg">
            <h2 className="text-xl font-bold text-white mb-6">Add New Target</h2>
            <form onSubmit={handleAddTarget}>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                  <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="name">
                    Target Name *
                  </label>
                  <input
                    id="name"
                    type="text"
                    value={newTarget.name}
                    onChange={(e) => setNewTarget({ ...newTarget, name: e.target.value })}
                    className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
                    placeholder="e.g., Instaffo GmbH"
                    required
                  />
                </div>
                <div>
                  <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="url">
                    Target URL *
                  </label>
                  <input
                    id="url"
                    type="url"
                    value={newTarget.url}
                    onChange={(e) => setNewTarget({ ...newTarget, url: e.target.value })}
                    className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
                    placeholder="https://example.com"
                    required
                  />
                </div>
              </div>
              <div className="mb-6">
                <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="description">
                  Description (Optional)
                </label>
                <textarea
                  id="description"
                  value={newTarget.description}
                  onChange={(e) => setNewTarget({ ...newTarget, description: e.target.value })}
                  rows="3"
                  className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
                  placeholder="Additional notes about this target..."
                />
              </div>
              <button
                type="submit"
                className="w-full bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317] text-white font-bold py-3 px-4 rounded-lg shadow-[0_0_20px_rgba(255,163,23,0.3)] hover:shadow-[0_0_30px_rgba(255,163,23,0.5)] transition-all duration-200"
              >
                Add Target
              </button>
            </form>
          </div>
        )}

        {/* Targets List */}
        {targets.length === 0 && !showAddForm && (
          <div className="bg-[#0a0b14] border border-white/10 rounded-xl p-12 text-center">
            <p className="text-white/50 mb-4">No targets added yet. Add your first target to get started.</p>
            <button
              onClick={() => setShowAddForm(true)}
              className="text-[#FFA317] hover:text-[#FF8C00] font-medium transition-colors"
            >
              + Add Your First Target
            </button>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {targets.filter(target => {
            if (!searchQuery) return true;
            const query = searchQuery.toLowerCase();
            return (
              target.name.toLowerCase().includes(query) ||
              target.url.toLowerCase().includes(query) ||
              (target.description && target.description.toLowerCase().includes(query))
            );
          }).map((target) => (
            <div
              key={target.id}
              className="bg-[#0a0b14] border border-white/10 rounded-xl p-6 shadow-lg hover:border-white/20 transition-all duration-300 relative group"
            >
              {/* Delete Icon in Corner */}
              <button
                onClick={() => handleDeleteTarget(target.id)}
                className="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 border border-red-500/20 hover:border-red-500/40 transition-all duration-200 opacity-0 group-hover:opacity-100"
                title="Delete target"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>

              {/* Target Info */}
              <div className="mb-4 pr-8">
                <h3 className="text-white font-bold text-xl mb-2">{target.name}</h3>
                <p className="text-white/50 text-sm font-mono break-all mb-2">{target.url}</p>
                {target.description && (
                  <p className="text-white/40 text-xs line-clamp-2">{target.description}</p>
                )}
              </div>

              {/* Actions */}
              <div className="pt-4 border-t border-white/5">
                <button
                  onClick={() => handleSchedulePentest(target)}
                  className="w-full bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317] text-white font-bold py-2.5 px-4 rounded-lg shadow-[0_0_15px_rgba(255,163,23,0.2)] hover:shadow-[0_0_25px_rgba(255,163,23,0.4)] transition-all duration-200"
                >
                  ▶ Schedule Pentest
                </button>
              </div>

              {/* Metadata */}
              <div className="mt-4 pt-3 border-t border-white/5">
                <p className="text-white/30 text-xs">
                  Added {new Date(target.created_at).toLocaleDateString()}
                </p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
