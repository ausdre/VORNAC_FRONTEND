import React, { useState } from 'react';
import { createJob } from '../api/client';

const Pentest = () => {
  const [formData, setFormData] = useState({
    target: '',
    scanType: 'quick',
    intensity: 'low',
    scope: 'full_domain',
    endpoints: '',
    scheduledTime: '',
    description: ''
  });
  const [status, setStatus] = useState({ loading: false, error: null, success: null });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setStatus({ loading: true, error: null, success: null });

    try {
      // Construct the payload matching the backend's InferenceJobCreate schema
      const inputData = {
        target: formData.target,
        scan_type: formData.scanType,
        intensity: formData.intensity,
        scope: formData.scope,
        endpoints: formData.endpoints,
        scheduled_time: formData.scheduledTime,
        description: formData.description
      };

      const data = await createJob(inputData);

      setStatus({ loading: false, error: null, success: `Pentest started successfully! Job ID: ${data.id}` });
      console.log('Job created:', data);
      
    } catch (err) {
      console.error('Error starting pentest:', err);
      const errorMessage = err.response?.data?.detail || 'Failed to start pentest. Please ensure you are logged in.';
      setStatus({ loading: false, error: errorMessage, success: null });
    }
  };

  return (
    <div className="min-h-screen bg-[#02030a] flex items-center justify-center p-4">
      <div className="bg-[#0a0b14] border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)] rounded-2xl p-8 max-w-lg w-full backdrop-blur-sm">
        <h2 className="text-2xl font-bold mb-6 text-white text-center tracking-wide">Start New Pentest</h2>
        
        {status.error && (
          <div className="bg-red-500/10 border-l-4 border-red-500 text-red-400 p-4 mb-4 rounded" role="alert">
            <p>{status.error}</p>
          </div>
        )}
        
        {status.success && (
          <div className="bg-green-500/10 border-l-4 border-green-500 text-green-400 p-4 mb-4 rounded" role="alert">
            <p>{status.success}</p>
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          {/* Target Input */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="target">
              Target URL / IP
            </label>
            <input
              type="text"
              id="target"
              name="target"
              value={formData.target}
              onChange={handleChange}
              required
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
              placeholder="https://example.com"
            />
          </div>

          {/* Scope Selection */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="scope">
              Scope
            </label>
            <select
              id="scope"
              name="scope"
              value={formData.scope}
              onChange={handleChange}
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
            >
              <option value="full_domain">Full Domain</option>
              <option value="subdomains">Include Subdomains</option>
              <option value="single_page">Single Page</option>
              <option value="api">API Only</option>
            </select>
          </div>

          {/* Endpoints Input */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="endpoints">
              Specific Endpoints (Optional)
            </label>
            <textarea
              id="endpoints"
              name="endpoints"
              value={formData.endpoints}
              onChange={handleChange}
              rows="3"
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
              placeholder="/api/v1/login, /admin, etc."
            />
          </div>

          {/* Scan Type Selection */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="scanType">
              Scan Type
            </label>
            <select
              id="scanType"
              name="scanType"
              value={formData.scanType}
              onChange={handleChange}
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
            >
              <option value="quick">Quick Scan</option>
              <option value="full">Full Scan</option>
              <option value="deep">Deep Vulnerability Analysis</option>
              <option value="compliance">Compliance Audit</option>
            </select>
          </div>

          {/* Intensity Selection */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="intensity">
              Intensity
            </label>
            <select
              id="intensity"
              name="intensity"
              value={formData.intensity}
              onChange={handleChange}
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
            >
              <option value="low">Low (Stealthy)</option>
              <option value="medium">Medium (Balanced)</option>
              <option value="high">High (Aggressive)</option>
            </select>
          </div>

          {/* Scheduled Time */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="scheduledTime">
              Schedule Start (Optional)
            </label>
            <input
              type="datetime-local"
              id="scheduledTime"
              name="scheduledTime"
              value={formData.scheduledTime}
              onChange={handleChange}
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors [color-scheme:dark]"
            />
          </div>

          {/* Description */}
          <div>
            <label className="block text-white/70 text-sm font-medium mb-2" htmlFor="description">
              Description
            </label>
            <textarea
              id="description"
              name="description"
              value={formData.description}
              onChange={handleChange}
              rows="3"
              className="w-full bg-[#02030a] border border-white/10 rounded-lg py-2.5 px-4 text-white placeholder-white/30 focus:outline-none focus:border-[#FFA317] focus:ring-1 focus:ring-[#FFA317] transition-colors"
              placeholder="Optional notes about this pentest..."
            />
          </div>

          {/* Submit Button */}
          <div className="flex items-center justify-center mt-6">
            <button
              type="submit"
              disabled={status.loading}
              className={`w-full bg-gradient-to-r from-[#FFA317] to-[#FF8C00] hover:from-[#FF8C00] hover:to-[#FFA317] text-white font-bold py-3 px-4 rounded-lg shadow-[0_0_20px_rgba(255,163,23,0.3)] hover:shadow-[0_0_30px_rgba(255,163,23,0.5)] focus:outline-none transition-all duration-200 transform hover:scale-[1.02] ${status.loading ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
              {status.loading ? 'Scheduling...' : 'Start Pentest'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default Pentest;